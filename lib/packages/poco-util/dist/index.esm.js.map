{"version":3,"file":"index.esm.js","sources":["../poco-util/src/events/dispatcher.ts"],"sourcesContent":["import { DefaultEventsMap, EventHandler, EventHandlers, EventNames, EventParameter, EventParameters, EventsMap } from \"./types\";\n\nexport type ListenerOptions = {\n    async: boolean\n}\n\nexport type OnceListenerOptions = ListenerOptions & {\n    signal: AbortSignal | undefined\n}\n\nexport class EventDispatcher<Events extends EventsMap = DefaultEventsMap> {\n    protected _listenerCount: number;\n\n    protected _listeners: Map<EventNames<Events>, {\n        callback: EventHandlers<Events>,\n        option: ListenerOptions\n    }[]>;\n\n    protected _onceListeners: Map<EventNames<Events>, {\n        resolveCallback: (...args: any) => void,\n        rejectCallback: (reason?: any) => void,\n        option: OnceListenerOptions\n    }[]>;\n\n    constructor() {\n        this._listenerCount = 0;\n        this._listeners = new Map();\n        this._onceListeners = new Map();\n    }\n\n    protected addListener\n        <Event extends EventNames<Events>,\n            Callback extends EventHandlers<Events> = EventHandler<Events, Event>>\n        (event: Event, callback: Callback, opt?: Partial<ListenerOptions>): boolean {\n\n        const option = { async: opt?.async || false };\n        const listeners = this._listeners.get(event);\n\n        if (!listeners) {\n            this._listeners.set(event, [{\n                callback,\n                option\n            }]);\n\n            return true;\n        }\n\n        if (listeners.find(e => e.callback == callback && e.option === option))\n            return false;\n\n        listeners.push({\n            callback,\n            option\n        })\n\n        this._listenerCount += 1;\n\n        return true;\n    }\n\n    protected addOnceListener<Event extends EventNames<Events>>\n        (\n            event: Event,\n            resolveCallback: (...args: EventParameter<Events, Event>) => void,\n            rejectCallback: (reason?: any) => void,\n            option: OnceListenerOptions\n        ) {\n\n        const listeners = this._onceListeners.get(event);\n\n        if (!listeners) {\n            this._onceListeners.set(event, [{\n                resolveCallback,\n                rejectCallback,\n                option\n            }]);\n\n            return;\n        }\n\n        listeners.push({\n            resolveCallback,\n            rejectCallback,\n            option\n        })\n\n        this._listenerCount += 1;\n    }\n\n    protected removeListener\n        <Event extends EventNames<Events>,\n            Callback extends EventHandlers<Events> = EventHandler<Events, Event>>\n        (event: Event, callback: Callback, opt?: Partial<ListenerOptions>): boolean {\n\n        const option = { async: opt?.async || false };\n        const listeners = this._listeners.get(event);\n\n        if (!listeners)\n            return false;\n\n        const index = listeners.findIndex(e => e.callback == callback && e.option === option);\n\n        if (index < 0)\n            return false;\n\n        listeners.splice(index, 1)\n\n        if (listeners.length === 0)\n            this._listeners.delete(event)\n\n        this._listenerCount -= 1;\n\n        return true;\n    }\n\n    protected triggerEvent\n        <Event extends EventNames<Events>,\n            Parameters extends EventParameters<Events> = EventParameter<Events, Event>>\n        (event: Event, args: Parameters) {\n\n        let listeners = this._listeners.get(event)?.slice();\n\n        if (listeners) {\n            for (const { callback, option: { async } } of listeners) {\n                if (async) {\n                    setImmediate(() => {\n                        callback.apply(this, args)\n                    })\n                } else {\n                    callback.apply(this, args)\n                }\n            }\n        }\n\n        let onceListeners = this._onceListeners.get(event)?.slice();\n\n        if (onceListeners) {\n            for (const { resolveCallback, rejectCallback, option: { async, signal } } of onceListeners) {\n                if (async) {\n                    if (signal && signal.aborted) {\n                        setImmediate(() => {\n                            rejectCallback.apply(this, [\"abort\"])\n                        })\n                    } else {\n                        setImmediate(() => {\n                            resolveCallback.apply(this, args)\n                        })\n                    }\n                } else {\n                    if (signal && signal.aborted) {\n                        rejectCallback.apply(this, [\"abort\"])\n                    } else {\n                        resolveCallback.apply(this, args)\n                    }\n                }\n            }\n\n            this._onceListeners.delete(event)\n        }\n    }\n\n    protected removeAllListeners<Event extends EventNames<Events>>(event?: Event) {\n        if (!event) {\n            this._listeners.clear();\n            return;\n        }\n\n        this._listeners.delete(event);\n    }\n\n    on\n        <Event extends EventNames<Events>,\n            Callback extends EventHandlers<Events> = EventHandler<Events, Event>>\n        (event: Event, callback: Callback, opt?: Partial<ListenerOptions>): boolean {\n        return this.addListener(event, callback, opt)\n    }\n\n    once\n        <Event extends EventNames<Events>>\n        (event: Event, opt?: Partial<Pick<OnceListenerOptions, \"async\" | \"signal\">>): Promise<EventParameter<Events, Event>> {\n\n        return new Promise((resolve, reject) => {\n            this.addOnceListener(event, resolve as any, reject, {\n                async: opt?.async || false,\n                signal: opt?.signal,\n            })\n        })\n    }\n\n    off\n        <Event extends EventNames<Events>,\n            Callback extends EventHandlers<Events> = EventHandler<Events, Event>>\n        (event: Event, callback: Callback, opt?: Partial<ListenerOptions>): boolean {\n        return this.removeListener(event, callback, opt)\n    }\n\n    emit\n        <Event extends EventNames<Events>,\n            Parameters extends EventParameters<Events> = EventParameter<Events, Event>>\n        (event: Event, args: Parameters) {\n        this.triggerEvent(event, args);\n    }\n\n    clear\n        <Event extends EventNames<Events>>(event?: Event) {\n        this.removeAllListeners(event);\n    }\n\n    listenerCount<Event extends EventNames<Events>>(event?: Event): number {\n        if (!event)\n            return this._listenerCount;\n\n        return this._listeners.get(event)?.length || 0;\n    }\n\n    listeners<Event extends EventNames<Events>>(event?: Event): {\n        callback: EventHandlers<Events>,\n        option: ListenerOptions\n    }[] {\n        if (!event) {\n            return Array.from(this._listeners.values()).flatMap(e => e);\n        }\n\n        return this._listeners.get(event) || []\n    }\n\n    eventNames(): EventNames<Events>[] {\n        return Array.from(this._listeners.keys())\n    }\n}\n\n"],"names":[],"mappings":"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"}