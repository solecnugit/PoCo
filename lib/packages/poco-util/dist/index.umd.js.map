{"version":3,"file":"index.umd.js","sources":["../poco-util/src/events/dispatcher.ts"],"sourcesContent":["import { DefaultEventsMap, EventHandler, EventHandlers, EventNames, EventParameter, EventParameters, EventsMap } from \"./types\";\n\nexport type ListenerOptions = {\n    async: boolean\n}\n\nexport type OnceListenerOptions = ListenerOptions & {\n    signal: AbortSignal | undefined\n}\n\nexport class EventDispatcher<Events extends EventsMap = DefaultEventsMap> {\n    protected _listenerCount: number;\n\n    protected _listeners: Map<EventNames<Events>, {\n        callback: EventHandlers<Events>,\n        option: ListenerOptions\n    }[]>;\n\n    protected _onceListeners: Map<EventNames<Events>, {\n        resolveCallback: (...args: any) => void,\n        rejectCallback: (reason?: any) => void,\n        option: OnceListenerOptions\n    }[]>;\n\n    constructor() {\n        this._listenerCount = 0;\n        this._listeners = new Map();\n        this._onceListeners = new Map();\n    }\n\n    protected addListener\n        <Event extends EventNames<Events>,\n            Callback extends EventHandlers<Events> = EventHandler<Events, Event>>\n        (event: Event, callback: Callback, opt?: Partial<ListenerOptions>): boolean {\n\n        const option = { async: opt?.async || false };\n        const listeners = this._listeners.get(event);\n\n        if (!listeners) {\n            this._listeners.set(event, [{\n                callback,\n                option\n            }]);\n\n            return true;\n        }\n\n        if (listeners.find(e => e.callback == callback && e.option === option))\n            return false;\n\n        listeners.push({\n            callback,\n            option\n        })\n\n        this._listenerCount += 1;\n\n        return true;\n    }\n\n    protected addOnceListener<Event extends EventNames<Events>>\n        (\n            event: Event,\n            resolveCallback: (...args: EventParameter<Events, Event>) => void,\n            rejectCallback: (reason?: any) => void,\n            option: OnceListenerOptions\n        ) {\n\n        const listeners = this._onceListeners.get(event);\n\n        if (!listeners) {\n            this._onceListeners.set(event, [{\n                resolveCallback,\n                rejectCallback,\n                option\n            }]);\n\n            return;\n        }\n\n        listeners.push({\n            resolveCallback,\n            rejectCallback,\n            option\n        })\n\n        this._listenerCount += 1;\n    }\n\n    protected removeListener\n        <Event extends EventNames<Events>,\n            Callback extends EventHandlers<Events> = EventHandler<Events, Event>>\n        (event: Event, callback: Callback, opt?: Partial<ListenerOptions>): boolean {\n\n        const option = { async: opt?.async || false };\n        const listeners = this._listeners.get(event);\n\n        if (!listeners)\n            return false;\n\n        const index = listeners.findIndex(e => e.callback == callback && e.option === option);\n\n        if (index < 0)\n            return false;\n\n        listeners.splice(index, 1)\n\n        if (listeners.length === 0)\n            this._listeners.delete(event)\n\n        this._listenerCount -= 1;\n\n        return true;\n    }\n\n    protected triggerEvent\n        <Event extends EventNames<Events>,\n            Parameters extends EventParameters<Events> = EventParameter<Events, Event>>\n        (event: Event, args: Parameters) {\n\n        let listeners = this._listeners.get(event)?.slice();\n\n        if (listeners) {\n            for (const { callback, option: { async } } of listeners) {\n                if (async) {\n                    setImmediate(() => {\n                        callback.apply(this, args)\n                    })\n                } else {\n                    callback.apply(this, args)\n                }\n            }\n        }\n\n        let onceListeners = this._onceListeners.get(event)?.slice();\n\n        if (onceListeners) {\n            for (const { resolveCallback, rejectCallback, option: { async, signal } } of onceListeners) {\n                if (async) {\n                    if (signal && signal.aborted) {\n                        setImmediate(() => {\n                            rejectCallback.apply(this, [\"abort\"])\n                        })\n                    } else {\n                        setImmediate(() => {\n                            resolveCallback.apply(this, args)\n                        })\n                    }\n                } else {\n                    if (signal && signal.aborted) {\n                        rejectCallback.apply(this, [\"abort\"])\n                    } else {\n                        resolveCallback.apply(this, args)\n                    }\n                }\n            }\n\n            this._onceListeners.delete(event)\n        }\n    }\n\n    protected removeAllListeners<Event extends EventNames<Events>>(event?: Event) {\n        if (!event) {\n            this._listeners.clear();\n            return;\n        }\n\n        this._listeners.delete(event);\n    }\n\n    on\n        <Event extends EventNames<Events>,\n            Callback extends EventHandlers<Events> = EventHandler<Events, Event>>\n        (event: Event, callback: Callback, opt?: Partial<ListenerOptions>): boolean {\n        return this.addListener(event, callback, opt)\n    }\n\n    once\n        <Event extends EventNames<Events>>\n        (event: Event, opt?: Partial<Pick<OnceListenerOptions, \"async\" | \"signal\">>): Promise<EventParameter<Events, Event>> {\n\n        return new Promise((resolve, reject) => {\n            this.addOnceListener(event, resolve as any, reject, {\n                async: opt?.async || false,\n                signal: opt?.signal,\n            })\n        })\n    }\n\n    off\n        <Event extends EventNames<Events>,\n            Callback extends EventHandlers<Events> = EventHandler<Events, Event>>\n        (event: Event, callback: Callback, opt?: Partial<ListenerOptions>): boolean {\n        return this.removeListener(event, callback, opt)\n    }\n\n    emit\n        <Event extends EventNames<Events>,\n            Parameters extends EventParameters<Events> = EventParameter<Events, Event>>\n        (event: Event, args: Parameters) {\n        this.triggerEvent(event, args);\n    }\n\n    clear\n        <Event extends EventNames<Events>>(event?: Event) {\n        this.removeAllListeners(event);\n    }\n\n    listenerCount<Event extends EventNames<Events>>(event?: Event): number {\n        if (!event)\n            return this._listenerCount;\n\n        return this._listeners.get(event)?.length || 0;\n    }\n\n    listeners<Event extends EventNames<Events>>(event?: Event): {\n        callback: EventHandlers<Events>,\n        option: ListenerOptions\n    }[] {\n        if (!event) {\n            return Array.from(this._listeners.values()).flatMap(e => e);\n        }\n\n        return this._listeners.get(event) || []\n    }\n\n    eventNames(): EventNames<Events>[] {\n        return Array.from(this._listeners.keys())\n    }\n}\n\n"],"names":[],"mappings":"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"}